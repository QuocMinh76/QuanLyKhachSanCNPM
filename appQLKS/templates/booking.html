{% extends 'layout/base.html' %}

{% block content %}
<div class="container">
    <h2 class="text-center mt-4">ĐẶT PHÒNG</h2>
    <form>

        <div>
            <label for="name" class="form-label">Tên người đặt</label>
            <input type="text" id="name" class="form-control"/>
        </div>
        <br/>
        <div class="row">
            <div class="col">
                <label for="checkin" class="form-label">Ngày nhận phòng</label>
                <input type="date" id="checkin" class="form-control"/>
            </div>
            <div class="col">
                <label for="checkout" class="form-label">Ngày trả phòng</label>
                <input type="date" id="checkout" class="form-control"/>
            </div>

        </div>
        <br/>
        <!-- Hiển thị tổng số khách thuê -->
        <div class="row">
            <div class="col">
                <label for="num_guests" class="form-label">Số lượng khách thuê đã thêm</label>
                <input type="number" id="num_guests" class="form-control" min="1" readonly/>
            </div>
            <!-- Hiển thị tổng số phòng thuê -->
            <div class="col">
                <label for="num_rooms" class="form-label">Số lượng phòng đã chọn</label>
                <input type="number" id="num_rooms" class="form-control" readonly min="0"/>
            </div>
        </div>
        <br/>
        <h5 class="mb-3">Chọn loại phòng</h5>
        <!-- Chọn loại phòng trong -->
        <div class="row">
            {% for room_type in room_types %}
            <div class="col-2 form-check form-check-inline">
                <input class="form-check-input room-type-checkbox" type="checkbox" value="{{ room_type.id }}"
                       id="room_type_{{ room_type.id }}" name="room_type_id">
                <label class="form-check-label" for="room_type_{{ room_type.id }}">{{ room_type.name }}</label>
            </div>
            {% endfor %}
        </div>
        <br/>
        <!-- Hiển thị danh sách phòng theo loại đã chọn dưới dạng có thể tick chọn nhiều-->
        <!--        tam de day mai an no chung voi danh sach-->
        <div class="row">
            <h5 class="mb-3 col-11">Danh sách phòng khả dụng</h5>
            <!-- Button to uncheck all selected rooms -->
            <button type="button" id="uncheckAllButton" class="btn btn-warning col-1 btn-circle"><i
                    class="fa fa-trash"></i></button>
        </div>

        <div class="list-view-container mt-3" id="room-list">
        </div>

        <br/>
        <!-- hiển thị tiêu đề "Danh sách khách hàng" -->
        <h5 class="mb-3">Danh sách khách hàng</h5>
        <!-- Hiển thị bảng danh sách khách hàng -->
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>Tên khách hàng</th>
                <th>Loại khách hàng</th>
                <th>CMND</th>
                <th>Địa chỉ</th>
            </tr>
            </thead>
            <tbody id="customerTableBody">
            <tr>
                <td><input type="text" class="form-control" placeholder="Tên khách hàng"></td>
                <td>
                    <select class="form-select">
                        <option value="Domestic">Nội địa</option>
                        <option value="Foreign">Quốc tế</option>
                    </select>
                </td>
                <td><input type="text" class="form-control" placeholder="CMND"></td>
                <td><input type="text" class="form-control" placeholder="Địa chỉ"></td>
            </tr>
            </tbody>
        </table>

        <div class="row" id="fnc_button">
            <div class="col">
                <button type="button" class="btn btn-dark btn-circle rounded-circle" id="addRowButton">&plus;</button>
                <button type="button" class="btn btn-dark btn-circle rounded-circle" id="removeRowButton">&minus;
                </button>
            </div>
            <div class="col d-flex justify-content-end">
                <button type="submit" class="btn btn-primary" id="confirmBookingButton">Đặt phòng</button>
            </div>
        </div>
    </form>
</div>
<style>
    .fnc_button {
        display: flex;
        justify-content: space-between;
    }
</style>
<script>
    // Get the container for the room list
    const roomListContainer = document.getElementById('room-list');
    const MAX_ITEMS_PER_ROW = 5; // Maximum number of items per row

    // Keep track of selected room IDs
    let selectedRooms = new Set();

    // Add event listeners to room type checkboxes
    document.querySelectorAll('.room-type-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', handleCheckboxChange);
    });

    // Handle changes in the room type checkboxes
    function handleCheckboxChange() {
        const selectedTypes = Array.from(document.querySelectorAll('.room-type-checkbox:checked')).map(cb => cb.value);

        // Clear the previous output
        roomListContainer.innerHTML = '';

        // If no room types are selected, hide the container and stop further processing
        if (selectedTypes.length === 0) {
            roomListContainer.style.display = 'none';
            return;
        }

        roomListContainer.style.display = 'block';

        // Collect all rooms for selected types in order
        const allRooms = [];
        selectedTypes.forEach(type => {
            fetchRoomsByType(type).then(rooms => {
                rooms.forEach(room => {
                    allRooms.push({ ...room, type }); // Attach the type to each room
                });

                // Once all room types are fetched, sort and display rooms
                if (allRooms.length > 0) {
                    displayRooms(allRooms);
                }
            }).catch(error => {
                console.error(`Error fetching rooms for type ${type}:`, error);
            });
        });
    }

    // Fetch room data by type from the server
    async function fetchRoomsByType(type) {
        try {
            const response = await fetch(`/api/rooms?room_type_id=${type}`);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error('Error fetching rooms:', error);
            return [];
        }
    }

    // Display all rooms in a grid layout
    function displayRooms(allRooms) {
        // Reset the grid layout
        roomListContainer.innerHTML = '';

        let currentRow = document.createElement('div');
        currentRow.classList.add('room-row');
        roomListContainer.appendChild(currentRow);

        allRooms.forEach((room, index) => {
            // Add room item
            const roomItem = createRoomItem(room, room.type, room.type_name);
            currentRow.appendChild(roomItem);

            // If the row is full, start a new row
            if ((index + 1) % MAX_ITEMS_PER_ROW === 0) {
                currentRow = document.createElement('div');
                currentRow.classList.add('room-row');
                roomListContainer.appendChild(currentRow);
            }
        });
    }

function createRoomItem(room, type, type_name) {
    const roomItem = document.createElement('div');
    roomItem.classList.add('room-item');
    roomItem.setAttribute('data-room-id', room.id); // Thêm data-room-id

    // Format giá phòng
    const formattedPrice = formatPrice(room.price);

    roomItem.innerHTML = `
        <div class="room-name">${room.name}</div>
        <div class="room-type">${type_name} - ${formattedPrice}</div>
    `;

    // Kiểm tra xem phòng đã được chọn chưa
    if (selectedRooms.has(room.id)) {
        roomItem.classList.add('selected');
        roomItem.style.backgroundColor = 'green'; // Đánh dấu phòng đã chọn
    }

    // Lắng nghe sự kiện click để chọn phòng
    roomItem.addEventListener('click', () => {
        // Toggle trạng thái chọn phòng
        roomItem.classList.toggle('selected');
        if (roomItem.classList.contains('selected')) {
            roomItem.style.backgroundColor = 'green';
            selectedRooms.add(room.id); // Thêm phòng vào danh sách chọn
        } else {
            roomItem.style.backgroundColor = '';
            selectedRooms.delete(room.id); // Xóa phòng khỏi danh sách chọn
        }

        // Cập nhật số lượng phòng đã chọn
        updateSelectedRoomCount();
    });

    return roomItem;
}

    // Function to update the count of selected rooms
    function updateSelectedRoomCount() {
        const numRoomsInput = document.getElementById('num_rooms');
        numRoomsInput. value = selectedRooms.size; // Set the number of selected rooms
    }

    // Function to uncheck all rooms
    function uncheckAllRooms() {
        // Remove 'selected' class and reset background for each room
        document.querySelectorAll('.room-item').forEach(roomItem => {
            roomItem.classList.remove('selected');
            roomItem.style.backgroundColor = ''; // Reset background color
        });

        // Clear the selectedRooms set
        selectedRooms.clear();

        // Update the count of selected rooms
        updateSelectedRoomCount();
    }

    // Format the price with commas and append "VNĐ"
    function formatPrice(price) {
        if (isNaN(price)) return price;
        const formatter = new Intl.NumberFormat('vi-VN', {
            style: 'decimal',
            maximumFractionDigits: 0,
        });
        return formatter.format(price) + ' VNĐ';
    }

    updateSelectedRoomCount()
    // Add event listener to the "Uncheck All" button
    document.getElementById('uncheckAllButton').addEventListener('click', uncheckAllRooms);
</script>
<script>
    // Function to update the number of guests
    function updateGuestCount() {
        const tableBody = document.getElementById('customerTableBody');
        const rows = tableBody.getElementsByTagName('tr');
        // Count the number of rows excluding the first one (static row)
        const guestCount = rows. length;
        document.getElementById('num_guests').value = guestCount;
    }

    document.getElementById('addRowButton').addEventListener('click', function () {
        const tableBody = document.getElementById('customerTableBody');
        const rows = tableBody.getElementsByTagName('tr');
        const lastRow = rows[rows.length - 1];
        const inputs = lastRow.querySelectorAll('input');
        let allFilled = true;

        // Check if all input fields in the last row are filled
        inputs.forEach(input => {
            if (input.value.trim() === '') {
                allFilled = false;
            }
        });

        if (allFilled) {
            // Create and append a new row
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" class="form-control" placeholder="Tên khách hàng"></td>
                <td>
                    <select class="form-select">
                        <option value="Nội địa">Nội địa</option>
                        <option value="Quốc tế">Quốc tế</option>
                    </select>
                </td>
                <td><input type="text" class="form-control" placeholder="CMND"></td>
                <td><input type="text" class="form-control" placeholder="Địa chỉ"></td>
            `;
            tableBody.appendChild(newRow);

            updateGuestCount();
        } else {
            alert('Please fill in all fields before adding a new row.');
        }
    });

    document.getElementById('removeRowButton').addEventListener('click', function () {
        const tableBody = document.getElementById('customerTableBody');
        const rows = tableBody.getElementsByTagName('tr');

        if (rows.length > 1) { // Ensure at least one input row remains
            tableBody.removeChild(rows[rows.length - 1]);

            updateGuestCount();
        }
    });

    updateGuestCount();
</script>
<script>
document.getElementById('confirmBookingButton').addEventListener('click', function(event) {
    event.preventDefault(); // Ngăn chặn hành vi submit mặc định

    // Thu thập thông tin từ form
    const bookingData = {
        name: document.getElementById('name').value,
        checkin: document.getElementById('checkin').value,
        checkout: document.getElementById('checkout').value,
        num_guests: document.getElementById('num_guests').value,
        num_rooms: document.getElementById('num_rooms').value,

        // Lấy danh sách các loại phòng đã chọn
        room_types: Array.from(document.querySelectorAll('.room-type-checkbox:checked')).map(cb => cb.value),

        // Lấy danh sách các phòng đã chọn từ các phòng trong danh sách phòng khả dụng
        selected_rooms: Array.from(document.querySelectorAll('.room-item.selected')).map(room => ({
            id: room.getAttribute('data-room-id'),
            name: room.querySelector('.room-name').innerText
        })),

        // Lấy thông tin khách hàng
        customers: Array.from(document.querySelectorAll('#customerTableBody tr')).map(row => ({
            name: row.querySelector('input[placeholder="Tên khách hàng"]').value,
            type: row.querySelector('select').value,
            id: row.querySelector('input[placeholder="CMND"]').value,
            address: row.querySelector('input[placeholder="Địa chỉ"]').value
        }))
    };

    // Lưu dữ liệu vào localStorage và chuyển hướng
    localStorage.setItem('bookingData', JSON.stringify(bookingData));
    window.location.href = 'booking_confirm';
});
</script>

{% endblock %}